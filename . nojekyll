name: Merge Playlists

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 */3 * * *"   # runs every 3 hours

jobs:
  merge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Run merge script
        run: |
          python3 - << 'PYCODE'
          def merge_playlists(channels_file, events_file, output_file):
              with open(channels_file, "r", encoding="utf-8") as f1:
                  channels = f1.read().strip()
              with open(events_file, "r", encoding="utf-8") as f2:
                  events = f2.read().strip()
              merged = "#EXTM3U\n"
              merged += "\n".join([l for l in channels.splitlines() if not l.startswith("#EXTM3U")])
              merged += "\n"
              merged += "\n".join([l for l in events.splitlines() if not l.startswith("#EXTM3U")])
              with open(output_file, "w", encoding="utf-8") as f_out:
                  f_out.write(merged)
              print(f"Merged playlist saved as {output_file}")

          merge_playlists("daddylive-channels.m3u8","daddylive-events.m3u8","daddylive-merged.m3u8")
          PYCODE

      - name: Create .nojekyll
        run: |
          echo "" > .nojekyll

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add daddylive-merged.m3u8 .nojekyll
          git commit -m "Auto-merge playlists + ensure Pages works" || echo "No changes to commit"
          git push
