name: Merge Playlists + Generate Index

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 */3 * * *"   # runs every 3 hours

jobs:
  merge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Run merge script
        run: |
          python3 - << 'PYCODE'
          import os

          def merge_playlists(channels_file, events_file, output_file):
              with open(channels_file, "r", encoding="utf-8") as f1:
                  channels = f1.read().strip()
              with open(events_file, "r", encoding="utf-8") as f2:
                  events = f2.read().strip()
              merged = "#EXTM3U\n"
              merged += "\n".join([l for l in channels.splitlines() if not l.startswith("#EXTM3U")])
              merged += "\n"
              merged += "\n".join([l for l in events.splitlines() if not l.startswith("#EXTM3U")])
              with open(output_file, "w", encoding="utf-8") as f_out:
                  f_out.write(merged)
              print(f"Merged playlist saved as {output_file}")

          merge_playlists("daddylive-channels.m3u8","daddylive-events.m3u8","daddylive-merged.m3u8")

          # Generate index.html
          m3u_files = [f for f in os.listdir('.') if f.endswith('.m3u8')]
          with open('index.html', 'w', encoding='utf-8') as f:
              f.write('<!DOCTYPE html><html><head><meta charset="utf-8"><title>DaddyLive Playlists</title></head><body>')
              f.write('<h1>DaddyLive Playlists</h1><ul>')
              for file in m3u_files:
                  f.write(f'<li><a href="{file}">{file}</a></li>')
              f.write('</ul></body></html>')
          print("index.html generated with playlist links")
          PYCODE

      - name: Create .nojekyll
        run: |
          echo "" > .nojekyll

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add daddylive-merged.m3u8 index.html .nojekyll
          git commit -
